http:
  middlewares:
    authentik:
      forwardAuth:
        address: 'http://authentik:9000/outpost.goauthentik.io/auth/traefik'
        trustForwardHeader: true
        authResponseHeaders:
          - 'X-authentik-username'
          - 'X-authentik-groups'
          - 'X-authentik-email'
          - 'X-authentik-name'
          - 'X-authentik-uid'

    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1m

    secure-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        frameDeny: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

  routers:
    # FreshRSS on RPi-Home
    freshrss:
      rule: 'Host(`rss.$DOMAIN`)'
      entryPoints:
        - websecure
      service: freshrss-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # Mealie on RPi-Home
    mealie:
      rule: 'Host(`mealie.$DOMAIN`)'
      entryPoints:
        - websecure
      service: mealie-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # Wallos on RPi-Home
    wallos:
      rule: 'Host(`wallos.$DOMAIN`)'
      entryPoints:
        - websecure
      service: wallos-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # SterlingPDF on RPi-Home
    pdf:
      rule: 'Host(`pdf.$DOMAIN`)'
      entryPoints:
        - websecure
      service: pdf-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # SearXNG on RPi-Home
    search:
      rule: 'Host(`search.$DOMAIN`)'
      entryPoints:
        - websecure
      service: search-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # VS Code Server on RPi-Home
    code:
      rule: 'Host(`code.$DOMAIN`)'
      entryPoints:
        - websecure
      service: code-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # OpenWebUI on RPi-Home
    chat:
      rule: 'Host(`chat.$DOMAIN`)'
      entryPoints:
        - websecure
      service: chat-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # Audiobookshelf on RPi-Home
    audiobooks:
      rule: 'Host(`books.$DOMAIN`)'
      entryPoints:
        - websecure
      service: audiobooks-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

    # n8n on RPi-Home
    n8n:
      rule: 'Host(`n8n.$DOMAIN`)'
      entryPoints:
        - websecure
      service: n8n-svc
      middlewares:
        - authentik
        - secure-headers
      tls:
        certResolver: cloudflare

  services:
    freshrss-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:8081'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    mealie-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:9925'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    wallos-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:8282'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    pdf-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:8082'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    search-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:8083'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    code-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:8443'
        healthCheck:
          path: /healthz
          interval: 30s
          timeout: 5s

    chat-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:8084'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    audiobooks-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:13378'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s

    n8n-svc:
      loadBalancer:
        servers:
          - url: 'http://$RPI_HOME_IP:5678'
        healthCheck:
          path: /
          interval: 30s
          timeout: 5s
