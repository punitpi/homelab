# stacks/overrides/cloud.traefik.yml
# This file contains labels to expose a service (e.g., FreshRSS on an RPi)
# through a cloud-based Traefik reverse proxy, protected by Authentik forward auth.
# This file is NOT used by the local docker-compose. It's a reference for your
# cloud Traefik's dynamic configuration.

# In your Traefik static config (traefik.yml on the cloud VM):
# providers:
#   docker:
#     exposedByDefault: false
#   file:
#     directory: /path/to/dynamic/configs
#     watch: true

# In your dynamic config file (e.g., /path/to/dynamic/configs/rpi-services.yml):
http:
  routers:
    freshrss-rpi:
      rule: "Host(`freshrss.{{env "DOMAIN"}}`)"
      entryPoints:
        - websecure
      service: freshrss-rpi-svc
      middlewares:
        - authentik # This middleware must be defined in your Traefik config

  services:
    freshrss-rpi-svc:
      loadBalancer:
        servers:
          # Use the Tailscale IP of your RPi-Home and the port you exposed it on
          - url: "http://<RPi-Home-Tailscale-IP>:8081"

  middlewares:
    authentik:
      forwardAuth:
        # URL of your Authentik outpost
        address: "http://authentik-outpost:9000/outpost.goauthentik.io/auth/traefik"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-authentik-username"
          - "X-authentik-groups"
          - "X-authentik-email"
          - "X-authentik-name"
          - "X-authentik-uid"
